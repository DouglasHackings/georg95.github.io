<!doctype html>
<meta charset="utf-8"/>
<html>
<head>
<title>test</title>
	
</head>
	<body onload="start()">
		<canvas width="800" height="600" id="game"></canvas>
<script>
"use strict"
var canvas = document.getElementById('game');
var area = canvas.getContext("2d");
var bgimg = new Image();
bgimg.src="bg.png";
var trolleyimg = new Image();
trolleyimg.src="trolley.png";
var handimg = new Image();
handimg.src="hand.png";
var dynamiteimg = new Image();
dynamiteimg.src="dynamite.png";
var manimg = new Image();
manimg.src="man.png";
var enemyimg = new Image();
enemyimg.src="enemy.png";
var man = {sizex:150/2, sizey:200/2,handangle:0};
var mx = 0; var my = 0;
var dx=0;
var clicked = false;
var worldx = 0;

var dynamites=[];
var effects=[];
var enemies=[];
function effectBigBoom(t, sx, sy, radius)
    {
    this.time = t;
    this.alltime=t;
    this.sx = sx;
    this.sy = sy;
    this.radius = radius;
    return this;
    };
effectBigBoom.prototype.update=function() { if(this.time <= 0) { return false; } this.time-=1; return true; }
effectBigBoom.prototype.draw = function()
    {
    area.globalAlpha=this.time/this.alltime;
    area.strokeStyle = "#FF0";
    area.lineWidth=this.radius/4;
    area.beginPath();
    area.arc(this.sx,this.sy,this.radius*(1-this.time/this.alltime),0,2*Math.PI);
    area.stroke();
    area.globalAlpha=1;
    }
function dynamite(x,y,fx,fy)
    {
    this.x = x;
    this.y = y;
    this.dx = fx-x;
    this.dy = fy-y;
    this.sx = x;
    this.sy = y;
    this.t = 0;
    this.angle = 0; 
    }
dynamite.prototype.sizex=50;
dynamite.prototype.sizey=50;
dynamite.prototype.update = function()
    {
    this.t+=1;
    if(this.t>=100)
        {
        AoeDamage(this.x, this.y, 100, 100);
        addEntity(effects, new effectBigBoom(50, this.x, this.y, 100)); return false;
        }
    this.x=this.sx+this.dx*this.t/100;
    this.y=this.sy+this.dy*this.t/100;
    this.angle+=0.2;
    return true;
    }
dynamite.prototype.draw= function()
    {
    area.translate(this.x, this.y);
    area.rotate(this.angle);
    area.drawImage(dynamiteimg, -this.sizex/2, -this.sizey/2, this.sizex, this.sizey);
    area.setTransform(1, 0, 0, 1, 0, 0);
    }

function updateEntities(array) { for(var i in array) { if(!array[i].update()) { delete array[i];} } }
function drawEntities(array) { for(var i in array) { array[i].draw(); } }
function addEntity(array, ent)
    {
    for(var i = 0; i <= array.length; i++)
        {
        if(array[i] === undefined) { array[i]=ent; break; }
        }
    }
man.draw = function(x,y,left)
    {
    area.translate(x, y);
    if(left) { area.scale(-1,1); }
    area.drawImage(manimg, -this.sizex/2, -this.sizey, this.sizex, this.sizey);
    area.setTransform(1, 0, 0, 1, 0, 0);
    }
man.drawhand = function(x,y,left)
    {
    var handx = x;
    var handy = y-this.sizey/3;
    area.translate(handx, handy);
    if(left) { area.scale(-1,1); }
    area.rotate(this.handangle);
    area.drawImage(handimg, -50/4, -50/4, 180/2, 50/2);
    area.setTransform(1, 0, 0, 1, 0, 0);
    }
man.update=function()
    {
    this.handangle-=0.1;
    }
var trolley = {x:300,y:200,vx:4,vy:0,sizex:300/2,sizey:200/2};
trolley.update=function()
    {
    this.x+=this.vx;
    this.y+=this.vy;
    if(this.x<0){this.x=0; this.vx=-this.vx;}
    if(this.y<0){this.y=0; this.vy=-this.vy;}
    if(this.x>canvas.width) {this.x=canvas.width;  this.vx=-this.vx;}
    if(this.y>canvas.height){this.y=canvas.height; this.vy=-this.vy;}
    man.update();
    }
trolley.draw=function()
    {
    var flip=this.vx>0?false:true;
    man.draw(this.x, this.y-this.sizey/3, flip);
    man.drawhand(this.x, this.y-this.sizey/3, flip);
    area.drawImage(trolleyimg, this.x-this.sizex/2, this.y-this.sizey/2,this.sizex,this.sizey);
    }
function drawBg(dx)
    {
    var dxs = Math.floor(dx/canvas.width*800);
    if(dx != canvas.width) area.drawImage(bgimg,dxs,0,800-dxs, 600, 0,0, canvas.width-dx,canvas.height);
    if(dx != 0) area.drawImage(bgimg,0,0,dxs, 600, canvas.width-dx,0, dx,canvas.height);
    }
function Enemy(x,y,vx,vy)
    {
    this.x=x;
    this.y=y;
    this.vx=vx;
    this.vy=vy;
    this.step=0;
    this.hp = 100;
    }
Enemy.prototype.maxhp = 100;
Enemy.prototype.size = 64;
Enemy.prototype.hit=function(dmg)
    {
    this.hp-=dmg;
    if(this.hp<0) { this.hp = 0; }
    }
Enemy.prototype.update = function()
    {
    if(this.hp<=0) { return false; }
    this.step++;
    if(this.step>20) { this.step = 0; }
    this.x+=this.vx;
    this.y+=this.vy;
    if(this.x<0){this.x=0; this.vx=-this.vx;}
    if(this.y<0){this.y=0; this.vy=-this.vy;}
    if(this.x>canvas.width) {this.x=canvas.width;  this.vx=-this.vx;}
    if(this.y>canvas.height){this.y=canvas.height; this.vy=-this.vy;}
    return true;
    }
Enemy.prototype.draw = function()
    {
    area.fillStyle = "#0F0";
    area.translate(this.x, this.y);
    area.fillRect(-this.size/2, -this.size/2, Math.round(this.size*this.hp/this.maxhp), 4);
    if(this.step > 10) { area.scale(-1,1); }
    area.drawImage(enemyimg, -this.size/2, -this.size/2, this.size, this.size);
    area.setTransform(1, 0, 0, 1, 0, 0);
    }
function AoeDamage(x, y, radius, dmg)
    {
    for(var i in enemies)
        {
        var dst = Math.sqrt((enemies[i].x-x)*(enemies[i].x-x)+(enemies[i].y-y)*(enemies[i].y-y));
        if (dst < radius)
            {
            enemies[i].hit(dmg*(radius-dst)/radius);
            }
        }
    }
function AddEnemies()
    {
    if(Math.random()<0.01)
        {
        var en = new Enemy(Math.random()*canvas.width, canvas.height,
                           -1.5+Math.random()*3,-1-Math.random()*2)
        addEntity(enemies, en);
        }
    }
function DrawLoop()
    {
    //area.fillStyle="#FFF";
    //worldx-=2;
    //dx-=2;
    if(dx < 0) { dx+=canvas.width; }
    if(dx >= canvas.width) { dx-=canvas.width; }
    drawBg(dx);
    if(clicked) { addEntity(dynamites, new dynamite(trolley.x, trolley.y, mx, my)); }
    updateEntities(dynamites);
    updateEntities(effects);
    AddEnemies();
    updateEntities(enemies);
    trolley.update();
    trolley.draw();
    drawEntities(enemies);
    drawEntities(dynamites);
    drawEntities(effects);
    window.requestAnimationFrame(DrawLoop);
    clicked=false;
    }
function start()
    {
    (function() {
      var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                  window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
      window.requestAnimationFrame = requestAnimationFrame;
    })();
    canvas.onclick=function(e) { clicked = true; mx = e.pageX-canvas.offsetLeft; my = e.pageY-canvas.offsetTop; }
    canvas.onkeydown=function(e)
        {
        ;
        }
    window.requestAnimationFrame(DrawLoop);
    }
</script>
    </body>
</html>
